<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/dash.css">
  <link rel="icon" href="../assets/icon/sunrise.png" />
  <title>Estátiticas..</title>

  <!-- scripts do Chart.js - 2022-1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!--Navebar-->
  <nav>
    <div class="nav-container">
      <img class="logo" src="../assets/icon/sunrise.png" alt="LF" style="width: 50px; height: auto;">


      <a href="../dashboard/diarioLF.html">
        <img src="../assets/icon/book-removebg-preview.png">
      </a>

      <a class="checado" href="../dashboard/alldash.html">
        <img src="../assets/icon/tocador-de-musica-removebg-preview.png">
      </a>



      <a href="../dashboard/userdash.html">
        <img src="../assets/icon/usericon.png">
      </a>


      <a href="../index.html">
        <img src="../assets/icon/logout-removebg-preview.png">
      </a>
    </div>
  </nav>


  <!--Fim do nav-bar-->


</head>


<body onload="Musicatotal(); Artistatotal(); obterDadosGrafico(); plotarGrafico(); ">

  <div class="page">
    <div class="cardD">
      <h2 id="titulo1">Estátiticas dos <br> Lusco-Fusco's</h2>
      <br>
      <br>
      <div class="graph">
        <canvas id="myChartCanvas"></canvas>
      </div>

      <br><br>
    </div>
    <div class="cardP">
      <div id="MusicaTotal"></div>
    </div>

    <div class="cardF">
      <div id="ArtistaTotal"></div>
    </div>

</body>
<script>

  function Musicatotal() {

    fetch(`/dash/Musicatotal/`)
      .then(res => res.json())
      .then(musicas => {
        if (!musicas || musicas.length == 0) {
          MusicaTotal.innerHTML = "<p>Nenhuma música encontrada.</p>";
          return;
        }

        MusicaTotal.innerHTML = "<h2>Música mais tocadas <br> De todo Lusco-Fusco</h2><br>";

        for (var i = 0; i < musicas.length; i++) {
          var m = musicas[i];
          MusicaTotal.innerHTML +=
            "<p>Música: " + m.Musica +
            " | Vezes: " + m.Quantidade + "</p> <br>";
        }
      })
      .catch(err => {
        console.error("Erro ao buscar músicas:", err);
        MusicaTotal.innerHTML = "<p>Erro ao carregar músicas.</p>";
      });
  }

  function Artistatotal() {

    fetch(`/dash/Artistatotal/`)
      .then(res => res.json())
      .then(artistas => {
        if (!artistas || artistas.length == 0) {
          ArtistaTotal.innerHTML = "<p>Nenhum artista encontrado.</p>";
          return;
        }

        ArtistaTotal.innerHTML = "<h2>Artistas mais tocados <br> De todo Lusco-Fusco</h2><br>";

        for (var i = 0; i < artistas.length; i++) {
          var a = artistas[i];
          ArtistaTotal.innerHTML +=
            "<p>Artista: " + a.Artista +
            " | Vezes: " + a.Quantidade + "</p> <br>";
        }
      })
      .catch(err => {
        console.error("Erro ao buscar artistas:", err);
        ArtistaTotal.innerHTML = "<p>Erro ao carregar artistas.</p>";
      });
  }

  function obterDadosGrafico() {

    // if (proximaAtualizacao != undefined) {
    //   clearTimeout(proximaAtualizacao);
    // }

    fetch(`/musica/buscarMusicas`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*

  function plotarGrafico(resposta) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: ['Com música', 'Sem música'],
      datasets: [{
        data: [],
        backgroundColor: [
          'rgb(245, 194, 47)',
          'rgb(236, 122, 8)'
        ],
        borderWidth: 0.2,
        borderColor: 'rgb(0, 0, 0)',
      }]
    };
    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      dados.datasets[0].data.push(registro.diarios_com_musica, registro.diarios_sem_musica);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'pie',
      data: dados,
      options: {
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              color: 'white'
            }
          }
        }
      }
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`myChartCanvas`),
      config
    );
  }


  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas,

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models

</script>

</html>